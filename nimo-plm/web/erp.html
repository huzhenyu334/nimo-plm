<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nimo ERP - ä¼ä¸šèµ„æºç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }

        /* Layout */
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 240px; background: #1a1a2e; color: #fff; padding: 20px 0; flex-shrink: 0; }
        .sidebar h1 { font-size: 20px; padding: 0 20px 20px; border-bottom: 1px solid #333; }
        .sidebar h1 span { color: #4fc3f7; }
        .sidebar nav { margin-top: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 20px; color: #aaa; text-decoration: none; transition: all 0.2s; cursor: pointer; }
        .sidebar nav a:hover, .sidebar nav a.active { background: #16213e; color: #fff; border-left: 3px solid #4fc3f7; }
        .sidebar nav a .icon { margin-right: 10px; font-size: 18px; }
        .main { flex: 1; padding: 24px; overflow-x: auto; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .header h2 { font-size: 24px; }
        .header .actions { display: flex; gap: 10px; }

        /* Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-card .label { font-size: 13px; color: #888; margin-bottom: 8px; }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card .value.green { color: #4caf50; }
        .stat-card .value.blue { color: #2196f3; }
        .stat-card .value.orange { color: #ff9800; }
        .stat-card .value.red { color: #f44336; }

        /* Table */
        .table-container { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .table-toolbar { padding: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .table-toolbar input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 250px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #fafafa; padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: #666; border-bottom: 1px solid #eee; }
        td { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        tr:hover td { background: #fafafa; }

        /* Status badges */
        .badge { padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; display: inline-block; }
        .badge.green { background: #e8f5e9; color: #2e7d32; }
        .badge.blue { background: #e3f2fd; color: #1565c0; }
        .badge.orange { background: #fff3e0; color: #e65100; }
        .badge.red { background: #ffebee; color: #c62828; }
        .badge.gray { background: #f5f5f5; color: #757575; }
        .badge.yellow { background: #fffde7; color: #f57f17; }
        .badge.purple { background: #f3e5f5; color: #6a1b9a; }

        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn-primary { background: #1976d2; color: #fff; }
        .btn-primary:hover { background: #1565c0; }
        .btn-success { background: #4caf50; color: #fff; }
        .btn-success:hover { background: #388e3c; }
        .btn-danger { background: #f44336; color: #fff; }
        .btn-small { padding: 4px 10px; font-size: 12px; }
        .btn-outline { background: transparent; border: 1px solid #ddd; color: #555; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: #fff; border-radius: 8px; padding: 24px; width: 500px; max-width: 90vw; max-height: 80vh; overflow-y: auto; }
        .modal h3 { margin-bottom: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        /* Loading */
        .loading { text-align: center; padding: 40px; color: #888; }

        /* MRP specific */
        .mrp-results { margin-top: 16px; }
        .mrp-action { display: flex; align-items: center; gap: 8px; }

        /* Rating stars */
        .rating-A { color: #4caf50; font-weight: 700; }
        .rating-B { color: #2196f3; font-weight: 700; }
        .rating-C { color: #ff9800; font-weight: 700; }
        .rating-D { color: #f44336; font-weight: 700; }

        /* Toast */
        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 24px; border-radius: 4px; color: #fff; z-index: 2000; animation: slideIn 0.3s ease; }
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>
<div class="app">
    <div class="sidebar">
        <h1>ğŸ”§ Nimo <span>ERP</span></h1>
        <nav>
            <a onclick="showPage('dashboard')" class="active" id="nav-dashboard"><span class="icon">ğŸ“Š</span>Dashboard</a>
            <a onclick="showPage('suppliers')" id="nav-suppliers"><span class="icon">ğŸ­</span>ä¾›åº”å•†ç®¡ç†</a>
            <a onclick="showPage('purchase-orders')" id="nav-purchase-orders"><span class="icon">ğŸ“‹</span>é‡‡è´­è®¢å•</a>
            <a onclick="showPage('inventory')" id="nav-inventory"><span class="icon">ğŸ“¦</span>åº“å­˜ç®¡ç†</a>
            <a onclick="showPage('mrp')" id="nav-mrp"><span class="icon">ğŸ§®</span>MRPè®¡åˆ’</a>
            <a onclick="showPage('work-orders')" id="nav-work-orders"><span class="icon">ğŸ­</span>ç”Ÿäº§å·¥å•</a>
            <a onclick="showPage('customers')" id="nav-customers"><span class="icon">ğŸ‘¥</span>å®¢æˆ·ç®¡ç†</a>
            <a onclick="showPage('sales-orders')" id="nav-sales-orders"><span class="icon">ğŸ›’</span>é”€å”®è®¢å•</a>
            <a onclick="showPage('service-orders')" id="nav-service-orders"><span class="icon">ğŸ”§</span>å”®åæœåŠ¡</a>
        </nav>
    </div>
    <div class="main" id="content">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal-content"></div>
</div>

<script>
const API_BASE = '/api/v1/erp';
const TOKEN = localStorage.getItem('token') || prompt('è¯·è¾“å…¥JWT Token:');
if (TOKEN) localStorage.setItem('token', TOKEN);

async function api(path, options = {}) {
    const res = await fetch(API_BASE + path, {
        ...options,
        headers: { 'Authorization': 'Bearer ' + TOKEN, 'Content-Type': 'application/json', ...options.headers }
    });
    return res.json();
}

function toast(msg, type = 'success') {
    const el = document.createElement('div');
    el.className = 'toast ' + type;
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

function showModal(html) {
    document.getElementById('modal-content').innerHTML = html;
    document.getElementById('modal-overlay').classList.add('active');
}

function closeModal() {
    document.getElementById('modal-overlay').classList.remove('active');
}

document.getElementById('modal-overlay').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

function statusBadge(status) {
    const map = {
        'ACTIVE': 'green', 'DRAFT': 'gray', 'PENDING': 'orange', 'APPROVED': 'blue',
        'SENT': 'purple', 'PARTIAL': 'yellow', 'RECEIVED': 'green', 'CLOSED': 'gray',
        'CANCELLED': 'red', 'CREATED': 'gray', 'PLANNED': 'blue', 'RELEASED': 'purple',
        'IN_PROGRESS': 'orange', 'COMPLETED': 'green', 'CONFIRMED': 'blue',
        'PICKING': 'orange', 'SHIPPED': 'purple', 'DELIVERED': 'green',
        'ASSIGNED': 'blue', 'WAITING_PARTS': 'yellow', 'RUNNING': 'orange',
        'APPLIED': 'green', 'FAILED': 'red', 'INACTIVE': 'gray', 'BLACKLIST': 'red'
    };
    return `<span class="badge ${map[status] || 'gray'}">${status}</span>`;
}

let currentPage = 'dashboard';

function showPage(page) {
    currentPage = page;
    document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
    document.getElementById('nav-' + page)?.classList.add('active');
    window['page_' + page.replace(/-/g, '_')]?.();
}

// ======== DASHBOARD ========
async function page_dashboard() {
    const [suppliers, pos, inventory, sos, wos, svcs, alerts] = await Promise.all([
        api('/suppliers?size=1'), api('/purchase-orders?size=1'), api('/inventory?size=1'),
        api('/sales-orders?size=1'), api('/work-orders?size=1'), api('/service-orders?size=1'),
        api('/inventory/alerts')
    ]);

    document.getElementById('content').innerHTML = `
        <div class="header"><h2>ğŸ“Š Dashboard</h2></div>
        <div class="stats-grid">
            <div class="stat-card"><div class="label">ä¾›åº”å•†æ€»æ•°</div><div class="value blue">${suppliers.data?.total || 0}</div></div>
            <div class="stat-card"><div class="label">é‡‡è´­è®¢å•</div><div class="value orange">${pos.data?.total || 0}</div></div>
            <div class="stat-card"><div class="label">åº“å­˜å“é¡¹</div><div class="value green">${inventory.data?.total || 0}</div></div>
            <div class="stat-card"><div class="label">åº“å­˜é¢„è­¦</div><div class="value red">${alerts.data?.length || 0}</div></div>
            <div class="stat-card"><div class="label">é”€å”®è®¢å•</div><div class="value blue">${sos.data?.total || 0}</div></div>
            <div class="stat-card"><div class="label">ç”Ÿäº§å·¥å•</div><div class="value orange">${wos.data?.total || 0}</div></div>
            <div class="stat-card"><div class="label">æœåŠ¡å·¥å•</div><div class="value">${svcs.data?.total || 0}</div></div>
        </div>
        <div class="stats-grid">
            <div class="table-container" style="grid-column: span 2;">
                <div class="table-toolbar"><strong>æœ€è¿‘é‡‡è´­è®¢å•</strong></div>
                <table><thead><tr><th>POç¼–å·</th><th>çŠ¶æ€</th><th>é‡‘é¢</th><th>åˆ›å»ºæ—¶é—´</th></tr></thead>
                <tbody id="dashboard-pos"></tbody></table>
            </div>
        </div>`;

    const posData = await api('/purchase-orders?size=5');
    document.getElementById('dashboard-pos').innerHTML = (posData.data?.items || []).map(po => `
        <tr><td>${po.po_code}</td><td>${statusBadge(po.status)}</td><td>Â¥${po.total_amount?.toFixed(2)}</td><td>${new Date(po.created_at).toLocaleDateString()}</td></tr>
    `).join('') || '<tr><td colspan="4" style="text-align:center;color:#888;">æš‚æ— æ•°æ®</td></tr>';
}

// ======== SUPPLIERS ========
async function page_suppliers() {
    const data = await api('/suppliers');
    document.getElementById('content').innerHTML = `
        <div class="header"><h2>ğŸ­ ä¾›åº”å•†ç®¡ç†</h2><div class="actions"><button class="btn btn-primary" onclick="showCreateSupplier()">+ æ–°å¢ä¾›åº”å•†</button></div></div>
        <div class="table-container">
            <table><thead><tr><th>ç¼–ç </th><th>åç§°</th><th>ç±»å‹</th><th>è”ç³»äºº</th><th>è¯„çº§</th><th>ç»¼åˆè¯„åˆ†</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
            <tbody>${(data.data?.items || []).map(s => `
                <tr>
                    <td>${s.supplier_code}</td><td>${s.name}</td><td>${s.type}</td><td>${s.contact_name}</td>
                    <td><span class="rating-${s.rating || '-'}">${s.rating || '-'}</span></td>
                    <td>${s.overall_score?.toFixed(1) || '0.0'}</td>
                    <td>${statusBadge(s.status)}</td>
                    <td><button class="btn btn-small btn-outline" onclick="showScoreSupplier('${s.id}')">è¯„åˆ†</button></td>
                </tr>`).join('')}</tbody></table>
        </div>`;
}

function showCreateSupplier() {
    showModal(`<h3>æ–°å¢ä¾›åº”å•†</h3>
        <div class="form-group"><label>åç§°*</label><input id="sup-name" required></div>
        <div class="form-group"><label>ç±»å‹*</label><select id="sup-type"><option value="COMPONENT">å…ƒå™¨ä»¶</option><option value="RAW_MATERIAL">åŸææ–™</option><option value="STRUCTURAL">ç»“æ„ä»¶</option><option value="PACKAGING">åŒ…è£…</option></select></div>
        <div class="form-group"><label>è”ç³»äºº*</label><input id="sup-contact"></div>
        <div class="form-group"><label>ç”µè¯*</label><input id="sup-phone"></div>
        <div class="form-group"><label>é‚®ç®±</label><input id="sup-email"></div>
        <div class="form-group"><label>åœ°å€*</label><input id="sup-address"></div>
        <div class="form-group"><label>ä»˜æ¬¾æ¡æ¬¾</label><input id="sup-payment" placeholder="å¦‚ï¼šæœˆç»“30å¤©"></div>
        <div class="form-actions"><button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="createSupplier()">åˆ›å»º</button></div>`);
}

async function createSupplier() {
    const body = {
        name: document.getElementById('sup-name').value,
        type: document.getElementById('sup-type').value,
        contact_name: document.getElementById('sup-contact').value,
        phone: document.getElementById('sup-phone').value,
        email: document.getElementById('sup-email').value,
        address: document.getElementById('sup-address').value,
        payment_terms: document.getElementById('sup-payment').value
    };
    const res = await api('/suppliers', { method: 'POST', body: JSON.stringify(body) });
    if (res.code === 0) { toast('ä¾›åº”å•†åˆ›å»ºæˆåŠŸ'); closeModal(); page_suppliers(); }
    else toast(res.message, 'error');
}

function showScoreSupplier(id) {
    showModal(`<h3>ä¾›åº”å•†è¯„åˆ†</h3>
        <div class="form-group"><label>è´¨é‡å¾—åˆ† (40%æƒé‡)</label><input id="score-quality" type="number" min="0" max="100" value="80"></div>
        <div class="form-group"><label>äº¤æœŸå¾—åˆ† (30%æƒé‡)</label><input id="score-delivery" type="number" min="0" max="100" value="80"></div>
        <div class="form-group"><label>ä»·æ ¼å¾—åˆ† (20%æƒé‡)</label><input id="score-price" type="number" min="0" max="100" value="80"></div>
        <div class="form-group"><label>æœåŠ¡å¾—åˆ† (10%æƒé‡)</label><input id="score-service" type="number" min="0" max="100" value="80"></div>
        <div class="form-actions"><button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="updateScore('${id}')">ä¿å­˜è¯„åˆ†</button></div>`);
}

async function updateScore(id) {
    const body = {
        quality_score: +document.getElementById('score-quality').value,
        delivery_score: +document.getElementById('score-delivery').value,
        price_score: +document.getElementById('score-price').value,
        service_score: +document.getElementById('score-service').value
    };
    const res = await api('/suppliers/' + id + '/score', { method: 'PUT', body: JSON.stringify(body) });
    if (res.code === 0) { toast('è¯„åˆ†æ›´æ–°æˆåŠŸ'); closeModal(); page_suppliers(); }
    else toast(res.message, 'error');
}

// ======== PURCHASE ORDERS ========
async function page_purchase_orders() {
    const data = await api('/purchase-orders');
    document.getElementById('content').innerHTML = `
        <div class="header"><h2>ğŸ“‹ é‡‡è´­è®¢å•</h2><div class="actions"><button class="btn btn-primary" onclick="showCreatePO()">+ æ–°å»ºé‡‡è´­è®¢å•</button></div></div>
        <div class="table-container">
            <table><thead><tr><th>POç¼–å·</th><th>ä¾›åº”å•†</th><th>çŠ¶æ€</th><th>æ€»é‡‘é¢</th><th>é¢„è®¡åˆ°è´§</th><th>æ“ä½œ</th></tr></thead>
            <tbody>${(data.data?.items || []).map(po => `
                <tr>
                    <td>${po.po_code}</td><td>${po.supplier?.name || '-'}</td>
                    <td>${statusBadge(po.status)}</td><td>Â¥${po.total_amount?.toFixed(2)}</td>
                    <td>${po.expected_date ? new Date(po.expected_date).toLocaleDateString() : '-'}</td>
                    <td>
                        ${po.status === 'DRAFT' ? `<button class="btn btn-small btn-primary" onclick="submitPO('${po.id}')">æäº¤</button>` : ''}
                        ${po.status === 'PENDING' ? `<button class="btn btn-small btn-success" onclick="approvePO('${po.id}')">å®¡æ‰¹</button>` : ''}
                        ${po.status === 'APPROVED' ? `<button class="btn btn-small btn-primary" onclick="sendPO('${po.id}')">å‘é€</button>` : ''}
                    </td>
                </tr>`).join('')}</tbody></table>
        </div>`;
}

async function submitPO(id) { const r = await api('/purchase-orders/' + id + '/submit', { method: 'POST' }); if (r.code === 0) { toast('å·²æäº¤'); page_purchase_orders(); } else toast(r.message, 'error'); }
async function approvePO(id) { const r = await api('/purchase-orders/' + id + '/approve', { method: 'POST' }); if (r.code === 0) { toast('å·²å®¡æ‰¹'); page_purchase_orders(); } else toast(r.message, 'error'); }
async function sendPO(id) { const r = await api('/purchase-orders/' + id + '/send', { method: 'POST' }); if (r.code === 0) { toast('å·²å‘é€'); page_purchase_orders(); } else toast(r.message, 'error'); }

function showCreatePO() {
    showModal(`<h3>æ–°å»ºé‡‡è´­è®¢å•</h3><p style="color:#888;font-size:13px;">è¯·é€šè¿‡APIåˆ›å»ºï¼ˆå‰ç«¯è¡¨å•å¼€å‘ä¸­ï¼‰</p>
        <div class="form-actions"><button class="btn btn-outline" onclick="closeModal()">å…³é—­</button></div>`);
}

// ======== INVENTORY ========
async function page_inventory() {
    const [data, alerts] = await Promise.all([api('/inventory'), api('/inventory/alerts')]);
    document.getElementById('content').innerHTML = `
        <div class="header"><h2>ğŸ“¦ åº“å­˜ç®¡ç†</h2></div>
        ${alerts.data?.length > 0 ? `<div style="background:#fff3e0;padding:12px 16px;border-radius:4px;margin-bottom:16px;border-left:4px solid #ff9800;">âš ï¸ æœ‰ ${alerts.data.length} ä¸ªç‰©æ–™åº“å­˜ä½äºå®‰å…¨åº“å­˜</div>` : ''}
        <div class="table-container">
            <table><thead><tr><th>ç‰©æ–™ç¼–ç </th><th>ç‰©æ–™åç§°</th><th>ç±»å‹</th><th>æ•°é‡</th><th>å¯ç”¨</th><th>é¢„ç•™</th><th>å®‰å…¨åº“å­˜</th><th>ä»“åº“</th></tr></thead>
            <tbody>${(data.data?.items || []).map(inv => `
                <tr>
                    <td>${inv.material_code || '-'}</td><td>${inv.material_name || '-'}</td>
                    <td>${inv.inventory_type}</td>
                    <td>${inv.quantity?.toFixed(2)}</td><td>${inv.available_qty?.toFixed(2)}</td><td>${inv.reserved_qty?.toFixed(2)}</td>
                    <td>${inv.safety_stock?.toFixed(2)}</td>
                    <td>${inv.warehouse?.name || '-'}</td>
                </tr>`).join('') || '<tr><td colspan="8" style="text-align:center;color:#888;">æš‚æ— åº“å­˜æ•°æ®</td></tr>'}</tbody></table>
        </div>`;
}

// ======== MRP ========
async function page_mrp() {
    const runs = await api('/mrp/runs');
    document.getElementById('content').innerHTML = `
        <div class="header"><h2>ğŸ§® MRPç‰©æ–™éœ€æ±‚è®¡åˆ’</h2><div class="actions"><button class="btn btn-success" onclick="runMRP()">â–¶ æ‰§è¡ŒMRPè®¡ç®—</button></div></div>
        <div class="table-container">
            <div class="table-toolbar"><strong>MRPè¿è¡Œå†å²</strong></div>
            <table><thead><tr><th>è¿è¡Œç¼–å·</th><th>çŠ¶æ€</th><th>ç‰©æ–™é¡¹æ•°</th><th>ç”ŸæˆPR</th><th>ç”ŸæˆWO</th><th>å¼€å§‹æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
            <tbody>${(runs.data?.items || []).map(r => `
                <tr>
                    <td>${r.run_code}</td><td>${statusBadge(r.status)}</td>
                    <td>${r.total_items}</td><td>${r.prs_generated}</td><td>${r.wos_generated}</td>
                    <td>${new Date(r.started_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-small btn-outline" onclick="viewMRPResult('${r.id}')">æŸ¥çœ‹ç»“æœ</button>
                        ${r.status === 'COMPLETED' ? `<button class="btn btn-small btn-primary" onclick="applyMRP('${r.id}')">ç¡®è®¤åº”ç”¨</button>` : ''}
                    </td>
                </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;color:#888;">æš‚æ— è¿è¡Œè®°å½•ï¼Œç‚¹å‡»"æ‰§è¡ŒMRPè®¡ç®—"å¼€å§‹</td></tr>'}</tbody></table>
        </div>
        <div id="mrp-results"></div>`;
}

async function runMRP() {
    toast('æ­£åœ¨æ‰§è¡ŒMRPè®¡ç®—...');
    const res = await api('/mrp/run', { method: 'POST', body: JSON.stringify({ planning_horizon: 30 }) });
    if (res.code === 0) { toast(`MRPè®¡ç®—å®Œæˆï¼å…± ${res.data.total_items} ä¸ªç‰©æ–™éœ€æ±‚`); page_mrp(); }
    else toast(res.message, 'error');
}

async function viewMRPResult(runId) {
    const res = await api('/mrp/result?run_id=' + runId);
    const items = res.data || [];
    document.getElementById('mrp-results').innerHTML = `
        <div class="table-container" style="margin-top:16px;">
            <div class="table-toolbar"><strong>MRPè®¡ç®—ç»“æœ</strong><span style="color:#888;margin-left:10px;">${items.length} æ¡</span></div>
            <table><thead><tr><th>ç‰©æ–™ç¼–ç </th><th>ç‰©æ–™åç§°</th><th>æ¯›éœ€æ±‚</th><th>ç°æœ‰åº“å­˜</th><th>åœ¨é€”</th><th>åœ¨åˆ¶</th><th>å‡€éœ€æ±‚</th><th>è®¡åˆ’æ•°é‡</th><th>åŠ¨ä½œ</th></tr></thead>
            <tbody>${items.map(i => `
                <tr style="${i.net_requirement > 0 ? 'background:#fff8e1;' : ''}">
                    <td>${i.material_code}</td><td>${i.material_name}</td>
                    <td>${i.gross_requirement?.toFixed(2)}</td><td>${i.on_hand_stock?.toFixed(2)}</td>
                    <td>${i.in_transit_qty?.toFixed(2)}</td><td>${i.in_production_qty?.toFixed(2)}</td>
                    <td><strong style="color:${i.net_requirement > 0 ? '#f44336' : '#4caf50'}">${i.net_requirement?.toFixed(2)}</strong></td>
                    <td>${i.planned_order_qty?.toFixed(2)}</td>
                    <td>${i.action_type === 'PURCHASE' ? '<span class="badge blue">é‡‡è´­</span>' : '<span class="badge purple">ç”Ÿäº§</span>'}</td>
                </tr>`).join('')}</tbody></table>
        </div>`;
}

async function applyMRP(runId) {
    if (!confirm('ç¡®è®¤åº”ç”¨MRPç»“æœï¼Ÿå°†è‡ªåŠ¨ç”Ÿæˆé‡‡è´­éœ€æ±‚å’Œç”Ÿäº§å·¥å•ã€‚')) return;
    const res = await api('/mrp/apply', { method: 'POST', body: JSON.stringify({ run_id: runId }) });
    if (res.code === 0) { toast('MRPç»“æœå·²åº”ç”¨'); page_mrp(); }
    else toast(res.message, 'error');
}

// ======== WORK ORDERS ========
async function page_work_orders() {
    const data = await api('/work-orders');
    document.getElementById('content').innerHTML = `
        <div class="header"><h2>ğŸ­ ç”Ÿäº§å·¥å•</h2></div>
        <div class="table-container">
            <table><thead><tr><th>å·¥å•ç¼–å·</th><th>äº§å“</th><th>BOMç‰ˆæœ¬</th><th>è®¡åˆ’æ•°é‡</th><th>å®Œæˆæ•°é‡</th><th>çŠ¶æ€</th><th>è®¡åˆ’å¼€å§‹</th><th>æ“ä½œ</th></tr></thead>
            <tbody>${(data.data?.items || []).map(wo => `
                <tr>
                    <td>${wo.wo_code}</td><td>${wo.product_name || '-'}</td><td>${wo.bom_version || '-'}</td>
                    <td>${wo.planned_qty}</td><td>${wo.completed_qty}</td>
                    <td>${statusBadge(wo.status)}</td>
                    <td>${wo.planned_start ? new Date(wo.planned_start).toLocaleDateString() : '-'}</td>
                    <td>
                        ${wo.status === 'CREATED' || wo.status === 'PLANNED' ? `<button class="btn btn-small btn-primary" onclick="releaseWO('${wo.id}')">ä¸‹è¾¾</button>` : ''}
                    </td>
                </tr>`).join('') || '<tr><td colspan="8" style="text-align:center;color:#888;">æš‚æ— å·¥å•</td></tr>'}</tbody></table>
        </div>`;
}

async function releaseWO(id) { const r = await api('/work-orders/' + id + '/release', { method: 'POST' }); if (r.code === 0) { toast('å·¥å•å·²ä¸‹è¾¾'); page_work_orders(); } else toast(r.message, 'error'); }

// ======== CUSTOMERS ========
async function page_customers() {
    const data = await api('/customers');
    document.getElementById('content').innerHTML = `
        <div class="header"><h2>ğŸ‘¥ å®¢æˆ·ç®¡ç†</h2><div class="actions"><button class="btn btn-primary" onclick="showCreateCustomer()">+ æ–°å¢å®¢æˆ·</button></div></div>
        <div class="table-container">
            <table><thead><tr><th>ç¼–ç </th><th>åç§°</th><th>ç±»å‹</th><th>è”ç³»äºº</th><th>ç”µè¯</th><th>çŠ¶æ€</th></tr></thead>
            <tbody>${(data.data?.items || []).map(c => `
                <tr><td>${c.customer_code}</td><td>${c.name}</td><td>${c.type}</td><td>${c.contact_name || '-'}</td><td>${c.phone || '-'}</td><td>${statusBadge(c.status)}</td></tr>
            `).join('')}</tbody></table>
        </div>`;
}

function showCreateCustomer() {
    showModal(`<h3>æ–°å¢å®¢æˆ·</h3>
        <div class="form-group"><label>åç§°*</label><input id="cust-name" required></div>
        <div class="form-group"><label>ç±»å‹</label><select id="cust-type"><option value="RETAIL">é›¶å”®</option><option value="WHOLESALE">æ‰¹å‘</option><option value="DISTRIBUTOR">ä»£ç†å•†</option><option value="ENTERPRISE">ä¼ä¸š</option></select></div>
        <div class="form-group"><label>è”ç³»äºº</label><input id="cust-contact"></div>
        <div class="form-group"><label>ç”µè¯</label><input id="cust-phone"></div>
        <div class="form-group"><label>åœ°å€</label><input id="cust-address"></div>
        <div class="form-actions"><button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="createCustomer()">åˆ›å»º</button></div>`);
}

async function createCustomer() {
    const body = {
        name: document.getElementById('cust-name').value,
        type: document.getElementById('cust-type').value,
        contact_name: document.getElementById('cust-contact').value,
        phone: document.getElementById('cust-phone').value,
        address: document.getElementById('cust-address').value
    };
    const res = await api('/customers', { method: 'POST', body: JSON.stringify(body) });
    if (res.code === 0) { toast('å®¢æˆ·åˆ›å»ºæˆåŠŸ'); closeModal(); page_customers(); }
    else toast(res.message, 'error');
}

// ======== SALES ORDERS ========
async function page_sales_orders() {
    const data = await api('/sales-orders');
    document.getElementById('content').innerHTML = `
        <div class="header"><h2>ğŸ›’ é”€å”®è®¢å•</h2></div>
        <div class="table-container">
            <table><thead><tr><th>SOç¼–å·</th><th>å®¢æˆ·</th><th>æ¸ é“</th><th>çŠ¶æ€</th><th>æ€»é‡‘é¢</th><th>ä¸‹å•æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead>
            <tbody>${(data.data?.items || []).map(so => `
                <tr>
                    <td>${so.so_code}</td><td>${so.customer?.name || '-'}</td><td>${so.channel}</td>
                    <td>${statusBadge(so.status)}</td><td>Â¥${so.total_amount?.toFixed(2)}</td>
                    <td>${so.order_date ? new Date(so.order_date).toLocaleDateString() : '-'}</td>
                    <td>
                        ${so.status === 'PENDING' ? `<button class="btn btn-small btn-success" onclick="confirmSO('${so.id}')">ç¡®è®¤</button>` : ''}
                        ${so.status === 'CONFIRMED' ? `<button class="btn btn-small btn-primary" onclick="shipSO('${so.id}')">å‘è´§</button>` : ''}
                    </td>
                </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;color:#888;">æš‚æ— è®¢å•</td></tr>'}</tbody></table>
        </div>`;
}

async function confirmSO(id) { const r = await api('/sales-orders/' + id + '/confirm', { method: 'POST' }); if (r.code === 0) { toast('å·²ç¡®è®¤'); page_sales_orders(); } else toast(r.message, 'error'); }
async function shipSO(id) { const r = await api('/sales-orders/' + id + '/ship', { method: 'POST', body: JSON.stringify({}) }); if (r.code === 0) { toast('å·²å‘è´§'); page_sales_orders(); } else toast(r.message, 'error'); }

// ======== SERVICE ORDERS ========
async function page_service_orders() {
    const data = await api('/service-orders');
    document.getElementById('content').innerHTML = `
        <div class="header"><h2>ğŸ”§ å”®åæœåŠ¡</h2></div>
        <div class="table-container">
            <table><thead><tr><th>æœåŠ¡å•å·</th><th>ç±»å‹</th><th>äº§å“SN</th><th>çŠ¶æ€</th><th>å¤„ç†äºº</th><th>åˆ›å»ºæ—¶é—´</th></tr></thead>
            <tbody>${(data.data?.items || []).map(so => `
                <tr>
                    <td>${so.service_code}</td><td>${so.service_type}</td><td>${so.product_sn}</td>
                    <td>${statusBadge(so.status)}</td><td>${so.assignee_name || '-'}</td>
                    <td>${new Date(so.created_at).toLocaleDateString()}</td>
                </tr>`).join('') || '<tr><td colspan="6" style="text-align:center;color:#888;">æš‚æ— æœåŠ¡å·¥å•</td></tr>'}</tbody></table>
        </div>`;
}

// Init
showPage('dashboard');
</script>
</body>
</html>
