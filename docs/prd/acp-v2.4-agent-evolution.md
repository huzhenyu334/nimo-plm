# ACP v2.4ï¼šAgentè¿›åŒ–ç³»ç»Ÿ + å·¥ä½œæµåœæ­¢

## æ¨¡å—æ¦‚è¿°

**Agentè¿›åŒ–ç³»ç»Ÿ**æ˜¯ACPçš„æ ¸å¿ƒæ¨¡å—ä¹‹ä¸€ï¼Œå®ç°"å·¥ä½œæµè¿è¡Œâ†’æ•°æ®é‡‡é›†â†’é—®é¢˜å‘ç°â†’æ¨¡æ¿å‡çº§â†’å®¡æ‰¹éƒ¨ç½²"çš„å®Œæ•´é—­ç¯ã€‚è®©Agentåƒäººä¸€æ ·ä»å·¥ä½œä¸­å­¦ä¹ ï¼Œè‡ªåŠ¨è¿›åŒ–ã€‚

æ•´åˆç°æœ‰çš„Agentæ¨¡æ¿ç®¡ç†ï¼ˆCRUD/ç‰ˆæœ¬/éƒ¨ç½²/diffï¼‰+ æ–°å¢çš„è¿è¡Œæ•°æ®åˆ†æå’Œè‡ªåŠ¨å‡çº§èƒ½åŠ›ã€‚

## é¡¹ç›®ä½ç½®

`/home/claw/.openclaw/workspace/agent-control-panel/`

## ç°æœ‰ä»£ç ï¼ˆå¿…è¯»ï¼‰

**å·²æœ‰çš„æ¨¡æ¿ç®¡ç†ï¼š**
- å®ä½“ï¼š`internal/acp/entity/entity.go` â†’ AgentTemplate, AgentTemplateFile, AgentTemplateVersion, AgentInstance
- APIï¼š`internal/acp/handler/template_handler.go`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- å‰ç«¯ï¼š`acp-web/src/pages/AgentTemplates.tsx`, `AgentTemplateDetail.tsx`
- APIå±‚ï¼š`acp-web/src/api/templates.ts`

**å¼•æ“ç›¸å…³ï¼š**
- å·¥ä½œæµå¼•æ“ï¼š`internal/acp/service/workflow_engine.go`
- å®¡æ‰¹æœåŠ¡ï¼š`internal/acp/service/approval_service.go`
- Lessonsåº“ï¼š`internal/acp/service/` ä¸­ lessons ç›¸å…³ä»£ç 
- Gatewayå®¢æˆ·ç«¯ï¼š`internal/acp/gateway/`

---

## Part 1ï¼šå·¥ä½œæµåœæ­¢èƒ½åŠ›

### éœ€æ±‚

å½“ç”¨æˆ·åœ¨å‰ç«¯ç‚¹å‡»"åœæ­¢å·¥ä½œæµ"æ—¶ï¼Œä¸ä»…è¦æ ‡è®°æ•°æ®åº“çŠ¶æ€ï¼Œè¿˜è¦è®©æ­£åœ¨æ‰§è¡Œçš„AgentçœŸæ­£åœä¸‹æ¥ã€‚

### æŠ€æœ¯æ–¹æ¡ˆ

OpenClawæ”¯æŒ `/stop` å‘½ä»¤ï¼šå‘é€åˆ°agent sessionåä¼šabortå½“å‰runã€æ¸…ç©ºæ’é˜Ÿæ¶ˆæ¯ã€åœæ­¢sub-agentã€‚

### åç«¯æ”¹åŠ¨

1. **`workflow_engine.go`** â€” æ–°å¢ `StopRun(runID string) error` æ–¹æ³•ï¼š
   ```go
   func (e *WorkflowEngine) StopRun(runID string) error {
       // 1. æ ‡è®°runä¸ºcancelled
       // 2. è§¦å‘context cancelï¼ˆå·²æœ‰çš„runCancels mapï¼‰
       // 3. æŸ¥æ‰¾æ‰€æœ‰running/waitingçš„step
       // 4. å¯¹æ¯ä¸ªstepçš„agentï¼Œé€šè¿‡Gatewayå‘é€/stop
       // 5. æ›´æ–°æ‰€æœ‰pending/running stepä¸ºcancelled
       // 6. å¦‚æœæœ‰pendingçš„approvalï¼Œä¹Ÿæ ‡è®°cancelled
   }
   ```

2. **Gateway `/stop` å‘é€** â€” é€šè¿‡ `gateway.Client` è°ƒç”¨ `agent` RPC ç»™ç›®æ ‡agentå‘ `/stop`ï¼š
   ```go
   // gateway/client.go æ–°å¢æ–¹æ³•
   func (c *Client) SendStop(agentID string) error {
       // è°ƒç”¨ agent RPC: {agentId, message: "/stop", sessionKey: "agent:<agentId>:main"}
   }
   ```

3. **`handler.go`** â€” æ–°å¢APIç«¯ç‚¹ï¼š
   ```
   POST /api/workflow-runs/:id/stop
   ```

4. **å‰ç«¯** â€” `WorkflowRunDetail.tsx` é¡µé¢çš„"åœæ­¢"æŒ‰é’®è°ƒç”¨æ­¤APIã€‚

---

## Part 2ï¼šAgent Performance Trackingï¼ˆè¿è¡Œæ•°æ®é‡‡é›†ï¼‰

### æ–°å¢å®ä½“

```go
// AgentPerformance è®°å½•agentåœ¨å·¥ä½œæµä¸­çš„è¡¨ç°æ•°æ®
type AgentPerformance struct {
    ID              string    `gorm:"primaryKey" json:"id"`
    AgentID         string    `gorm:"index;not null" json:"agent_id"`
    RunID           string    `gorm:"index;not null" json:"run_id"`
    StepID          string    `gorm:"not null" json:"step_id"`
    WorkflowID      string    `gorm:"index" json:"workflow_id"`
    
    // æ ¸å¿ƒæŒ‡æ ‡
    GateLoops       int       `json:"gate_loops"`         // gateå¾ªç¯äº†å‡ æ¬¡
    GatePassed      bool      `json:"gate_passed"`        // æœ€ç»ˆæ˜¯å¦é€šè¿‡gate
    ApprovalResult  string    `json:"approval_result"`    // approved/rejected/""
    Escalated       bool      `json:"escalated"`          // æ˜¯å¦è¢«escalate
    ExecutionTimeMs int64     `json:"execution_time_ms"`  // æ‰§è¡Œè€—æ—¶
    Attempt         int       `json:"attempt"`            // é‡è¯•äº†å‡ æ¬¡
    FinalStatus     string    `json:"final_status"`       // completed/failed/cancelled
    
    // é—®é¢˜åˆ†ç±»
    IssueCategory   string    `json:"issue_category"`     // å¦‚ï¼šui_inconsistency, missing_module, compile_error
    IssueDetail     string    `gorm:"type:text" json:"issue_detail"`
    
    CreatedAt       time.Time `json:"created_at"`
}

// UpgradeProposal å‡çº§ææ¡ˆ
type UpgradeProposal struct {
    ID              string     `gorm:"primaryKey" json:"id"`
    TemplateID      string     `gorm:"index;not null" json:"template_id"`
    AgentID         string     `gorm:"index;not null" json:"agent_id"`
    TriggerType     string     `gorm:"not null" json:"trigger_type"`     // gate_failure_rate/repeated_lesson/approval_reject_rate/manual
    TriggerDetail   string     `gorm:"type:text" json:"trigger_detail"`  // è§¦å‘åŸå› çš„è¯¦ç»†æ•°æ®
    ProposedChanges string     `gorm:"type:text" json:"proposed_changes"` // JSON: [{file, action, content, reason}]
    Status          string     `gorm:"default:'pending'" json:"status"`  // pending/approved/rejected/applied
    ApprovalID      *string    `json:"approval_id"`                      // å…³è”çš„å®¡æ‰¹è®°å½•
    AppliedAt       *time.Time `json:"applied_at"`
    CreatedAt       time.Time  `json:"created_at"`
    UpdatedAt       time.Time  `json:"updated_at"`
}
```

### æ•°æ®é‡‡é›†æ—¶æœº

åœ¨ `workflow_engine.go` ä¸­ï¼Œæ¯ä¸ªstepå®Œæˆæ—¶è‡ªåŠ¨è®°å½•performanceæ•°æ®ï¼š

```go
// åœ¨stepå®Œæˆçš„åœ°æ–¹ï¼ˆåŒ…æ‹¬gateå¾ªç¯ã€escalateã€æ­£å¸¸å®Œæˆç­‰ï¼‰è°ƒç”¨ï¼š
func (e *WorkflowEngine) recordPerformance(runID, stepID, agentID string, metrics PerformanceMetrics) {
    perf := &entity.AgentPerformance{
        ID:              uuid.New().String(),
        AgentID:         agentID,
        RunID:           runID,
        StepID:          stepID,
        WorkflowID:      workflowID,
        GateLoops:       metrics.GateLoops,
        GatePassed:      metrics.GatePassed,
        // ...
    }
    e.DB.Create(perf)
}
```

**é‡‡é›†ç‚¹ï¼š**
- æ™®é€šstepå®Œæˆæ—¶ï¼šè®°å½•æ‰§è¡Œæ—¶é—´ã€attemptæ¬¡æ•°ã€æœ€ç»ˆçŠ¶æ€
- Gateå¾ªç¯å®Œæˆæ—¶ï¼šè®°å½•å¾ªç¯æ¬¡æ•°ã€æ˜¯å¦æœ€ç»ˆé€šè¿‡
- Escalateå‘ç”Ÿæ—¶ï¼šè®°å½•è¢«å‡çº§äº‹å®
- å®¡æ‰¹å®Œæˆæ—¶ï¼šè®°å½•é€šè¿‡/æ‹’ç»

---

## Part 3ï¼šè‡ªåŠ¨å‡çº§è§¦å‘

### å¼•æ“çº§Post-Runåˆ†æ

å·¥ä½œæµrunç»“æŸåï¼ˆä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰ï¼Œå¼•æ“è‡ªåŠ¨æ‰§è¡Œåˆ†æï¼š

```go
func (e *WorkflowEngine) postRunAnalysis(runID string) {
    // 1. æ±‡æ€»æœ¬æ¬¡runçš„æ‰€æœ‰performanceæ•°æ®
    // 2. æŒ‰agentåˆ†ç»„ç»Ÿè®¡
    // 3. æ£€æŸ¥å‡çº§è§¦å‘æ¡ä»¶
    // 4. æ»¡è¶³æ¡ä»¶åˆ™åˆ›å»ºUpgradeProposal
}
```

### è§¦å‘æ¡ä»¶ï¼ˆå¯é…ç½®ï¼‰

ç³»ç»Ÿå†…ç½®é»˜è®¤æ¡ä»¶ï¼Œå­˜å‚¨åœ¨ACPçš„ç³»ç»Ÿé…ç½®ä¸­ï¼ˆä¸æ˜¯æ¯ä¸ªå·¥ä½œæµé‡Œé…ï¼‰ï¼š

```go
type UpgradeTriggerConfig struct {
    Enabled           bool    `json:"enabled"`
    GateFailureRate   float64 `json:"gate_failure_rate"`    // é»˜è®¤0.3ï¼ˆ30%å¤±è´¥ç‡ï¼‰
    GateFailureWindow int     `json:"gate_failure_window"`  // æœ€è¿‘Næ¬¡run
    RepeatedLessonMin int     `json:"repeated_lesson_min"`  // åŒç±»lessonå‡ºç°æ¬¡æ•°
    ApprovalRejectRate float64 `json:"approval_reject_rate"` // å®¡æ‰¹æ‹’ç»ç‡
    EscalateCountMin   int    `json:"escalate_count_min"`   // ç´¯è®¡escalateæ¬¡æ•°
}
```

### å‡çº§ææ¡ˆç”Ÿæˆ

å½“è§¦å‘æ¡ä»¶æ»¡è¶³æ—¶ï¼š

1. **è‡ªåŠ¨åˆ†æ** â€” æ”¶é›†è¯¥agentçš„æ‰€æœ‰ç›¸å…³lessonsã€gateåé¦ˆã€å®¡æ‰¹æ‹’ç»åŸå› 
2. **ç”Ÿæˆä¿®æ”¹å»ºè®®** â€” é€šè¿‡PM agentåˆ†æé—®é¢˜æ¨¡å¼ï¼Œç”ŸæˆAGENTS.mdçš„å…·ä½“ä¿®æ”¹æ–¹æ¡ˆ
3. **åˆ›å»ºUpgradeProposal** â€” è®°å½•ææ¡ˆå†…å®¹ã€å…³è”æ•°æ®
4. **åˆ›å»ºå®¡æ‰¹** â€” è‡ªåŠ¨åˆ›å»ºapprovalï¼Œé€šçŸ¥ç®¡ç†å‘˜ï¼ˆä½ ï¼‰å®¡æ‰¹
5. **å®¡æ‰¹é€šè¿‡** â†’ è‡ªåŠ¨åº”ç”¨åˆ°æ¨¡æ¿æ–‡ä»¶ â†’ éƒ¨ç½²åˆ°agent workspace
6. **å®¡æ‰¹æ‹’ç»** â†’ è®°å½•æ‹’ç»åŸå› ï¼Œåç»­ä¸é‡å¤æè®®åŒç±»ä¿®æ”¹

---

## Part 4ï¼šUIè®¾è®¡

### 4.1 ä¾§è¾¹æ ç»“æ„è°ƒæ•´

```
Dashboard
Agent ç›‘æ§
  â””â”€ Agentè¯¦æƒ…
ä»»åŠ¡ç®¡ç†
å·¥ä½œæµ
  â”œâ”€ å·¥ä½œæµåˆ—è¡¨
  â”œâ”€ è¿è¡Œè®°å½•
  â””â”€ è¿è¡Œè¯¦æƒ…
å®¡æ‰¹ä¸­å¿ƒ                    â† å·²æœ‰
Agent è¿›åŒ–                  â† æ–°æ¨¡å—å…¥å£
  â”œâ”€ è§’è‰²æ¨¡æ¿               â† å·²æœ‰ï¼Œç§»åˆ°è¿™é‡Œ
  â”œâ”€ è¿è¡Œè¡¨ç°               â† æ–°å¢
  â””â”€ å‡çº§ææ¡ˆ               â† æ–°å¢
è®¾ç½®
```

### 4.2 è¿è¡Œè¡¨ç°é¡µ (`/agent-performance`)

**é¡µé¢å¸ƒå±€ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent è¿è¡Œè¡¨ç°                        [æ—¶é—´èŒƒå›´é€‰æ‹©] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ PM      â”‚  â”‚ UX      â”‚  â”‚ Alice   â”‚  â”‚ å…¨éƒ¨    â”‚â”‚
â”‚  â”‚ é€šè¿‡ 85%â”‚  â”‚ é€šè¿‡ 72%â”‚  â”‚ é€šè¿‡ 91%â”‚  â”‚ é€šè¿‡ 83%â”‚â”‚
â”‚  â”‚ â—â—â—â—â—‹  â”‚  â”‚ â—â—â—â—‹â—‹  â”‚  â”‚ â—â—â—â—â—‹  â”‚  â”‚ â—â—â—â—â—‹  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è¶‹åŠ¿å›¾ï¼ˆæŠ˜çº¿å›¾ï¼‰                               â”‚  â”‚
â”‚  â”‚  â€” Gateé€šè¿‡ç‡  â€” ä¸€æ¬¡é€šè¿‡ç‡  â€” å¹³å‡è€—æ—¶         â”‚  â”‚
â”‚  â”‚  ğŸ“ˆ                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                      â”‚
â”‚  å¸¸è§é—®é¢˜ Top 5                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é—®é¢˜ç±»å‹             â”‚ æ¬¡æ•°â”‚ Agent  â”‚ è¶‹åŠ¿     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ UIé£æ ¼ä¸ä¸€è‡´         â”‚  12 â”‚ UX     â”‚ â†— ä¸Šå‡   â”‚  â”‚
â”‚  â”‚ æœªå®é™…è®¿é—®ç³»ç»Ÿ       â”‚   8 â”‚ PM/UX  â”‚ â†˜ ä¸‹é™   â”‚  â”‚
â”‚  â”‚ ç¼–è¯‘å¤±è´¥             â”‚   5 â”‚ Alice  â”‚ â†’ æŒå¹³   â”‚  â”‚
â”‚  â”‚ é—æ¼åŠŸèƒ½æ¨¡å—         â”‚   4 â”‚ PM     â”‚ â†˜ ä¸‹é™   â”‚  â”‚
â”‚  â”‚ æµ‹è¯•è¦†ç›–ä¸è¶³         â”‚   3 â”‚ Alice  â”‚ â†’ æŒå¹³   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                      â”‚
â”‚  æœ€è¿‘è¿è¡Œè®°å½•                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å·¥ä½œæµ  â”‚Agentâ”‚ æ­¥éª¤ â”‚Gateè½®â”‚çŠ¶æ€ â”‚ æ—¶é—´       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ PLMä¼˜åŒ–â”‚ UX  â”‚verifyâ”‚  3   â”‚âš escâ”‚ 2h ago     â”‚  â”‚
â”‚  â”‚ PLMä¼˜åŒ–â”‚ PM  â”‚check â”‚  1   â”‚ âœ…  â”‚ 3h ago     â”‚  â”‚
â”‚  â”‚ ...    â”‚     â”‚      â”‚      â”‚     â”‚            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’ï¼š**
- ç‚¹å‡»Agentå¡ç‰‡ â†’ ç­›é€‰è¯¥agentçš„æ•°æ®
- ç‚¹å‡»é—®é¢˜è¡Œ â†’ å±•å¼€è¯¦æƒ…ï¼Œæ˜¾ç¤ºç›¸å…³lessonså’Œå…·ä½“case
- æ—¶é—´èŒƒå›´ï¼šæœ€è¿‘7å¤©/30å¤©/å…¨éƒ¨
- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡å®æ—¶æ›´æ–°

### 4.3 å‡çº§ææ¡ˆé¡µ (`/upgrade-proposals`)

**åˆ—è¡¨é¡µï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‡çº§ææ¡ˆ                          [çŠ¶æ€ç­›é€‰] [æ–°å»º] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â”Œâ”€ å¾…å®¡æ‰¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ #UP-003  UX Agent è§„åˆ™å‡çº§ v2.1 â†’ v2.2       â”‚   â”‚
â”‚  â”‚ è§¦å‘ï¼šGateå¤±è´¥ç‡ 38%ï¼ˆé˜ˆå€¼30%ï¼‰               â”‚   â”‚
â”‚  â”‚ å½±å“ï¼šAGENTS.md +3æ¡è§„åˆ™                      â”‚   â”‚
â”‚  â”‚ ğŸ“Š åŸºäº12æ¬¡è¿è¡Œæ•°æ®                    [å®¡æ‰¹] â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€ å·²åº”ç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ #UP-002  PM Agent å·¡æ£€è§„åˆ™å¢å¼º v1.3 â†’ v1.4   â”‚   â”‚
â”‚  â”‚ è§¦å‘ï¼šé‡å¤lesson "æœªå®é™…è®¿é—®ç³»ç»Ÿ" Ã—5          â”‚   â”‚
â”‚  â”‚ æ•ˆæœï¼šGateé€šè¿‡ç‡ 72% â†’ 89% âœ…                 â”‚   â”‚
â”‚  â”‚ åº”ç”¨æ—¶é—´ï¼š2026-02-20               [æŸ¥çœ‹è¯¦æƒ…] â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€ å·²æ‹’ç» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ #UP-001  Alice ç¼–è¯‘è§„åˆ™è°ƒæ•´                    â”‚   â”‚
â”‚  â”‚ æ‹’ç»åŸå› ï¼šé—®é¢˜æ ¹å› æ˜¯é¡¹ç›®é…ç½®ï¼Œä¸æ˜¯agentè§„åˆ™   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ææ¡ˆè¯¦æƒ…é¡µï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† è¿”å›    #UP-003 UX Agent è§„åˆ™å‡çº§              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  çŠ¶æ€ï¼šğŸŸ¡ å¾…å®¡æ‰¹    æ¨¡æ¿ï¼šux-designer v2.1          â”‚
â”‚  è§¦å‘ç±»å‹ï¼šGateå¤±è´¥ç‡è¶…æ ‡                            â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€ è§¦å‘æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æœ€è¿‘10æ¬¡runä¸­ï¼ŒUX agent gateå¤±è´¥ç‡ï¼š38%       â”‚   â”‚
â”‚  â”‚ ä¸»è¦é—®é¢˜ï¼š                                    â”‚   â”‚
â”‚  â”‚  â€¢ æœªå®é™…æ‰“å¼€æµè§ˆå™¨éªŒè¯ï¼ˆ5æ¬¡ï¼‰                â”‚   â”‚
â”‚  â”‚  â€¢ æˆªå›¾ç¼ºå¤±ï¼ˆ3æ¬¡ï¼‰                           â”‚   â”‚
â”‚  â”‚  â€¢ UIåˆ¤æ–­ä¸PMä¸ä¸€è‡´ï¼ˆ2æ¬¡ï¼‰                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€ å»ºè®®ä¿®æ”¹ï¼ˆDiffé¢„è§ˆï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“„ AGENTS.md                                  â”‚   â”‚
â”‚  â”‚                                                â”‚   â”‚
â”‚  â”‚  ## å·¡æ£€è§„åˆ™                                   â”‚   â”‚
â”‚  â”‚ +### å¼ºåˆ¶è¦æ±‚ï¼ˆæ–°å¢ï¼‰                          â”‚   â”‚
â”‚  â”‚ +1. æ¯ä¸ªæ¨¡å—å¿…é¡»ç”¨browserå·¥å…·å®é™…è®¿é—®          â”‚   â”‚
â”‚  â”‚ +2. å¿…é¡»æˆªå›¾ä½œä¸ºéªŒè¯è¯æ®                       â”‚   â”‚
â”‚  â”‚ +3. ç¦æ­¢ä½¿ç”¨grep/execä»£æ›¿æµè§ˆå™¨éªŒè¯            â”‚   â”‚
â”‚  â”‚                                                â”‚   â”‚
â”‚  â”‚  [ç¼–è¾‘ä¿®æ”¹]                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€ å…³è”æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“‹ ç›¸å…³Lessons (5æ¡)         [å±•å¼€æŸ¥çœ‹]      â”‚   â”‚
â”‚  â”‚ ğŸ“Š ç›¸å…³è¿è¡Œè®°å½• (10æ¡)       [å±•å¼€æŸ¥çœ‹]      â”‚   â”‚
â”‚  â”‚ ğŸ“ å†å²å‡çº§ (1æ¬¡)            [å±•å¼€æŸ¥çœ‹]      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â”‚  [é€šè¿‡å¹¶åº”ç”¨]  [é€šè¿‡ä½†ä¿®æ”¹ååº”ç”¨]  [æ‹’ç»]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 æ¨¡æ¿è¯¦æƒ…é¡µå¢å¼ºï¼ˆå·²æœ‰é¡µé¢æ”¹é€ ï¼‰

åœ¨ç°æœ‰ `AgentTemplateDetail.tsx` çš„ Tabs ä¸­æ–°å¢ï¼š

```
[æ–‡ä»¶ç¼–è¾‘] [ç‰ˆæœ¬å†å²] [å®ä¾‹éƒ¨ç½²] [è¿è¡Œè¡¨ç°] [å‡çº§è®°å½•]
                                    â†‘æ–°å¢      â†‘æ–°å¢
```

**è¿è¡Œè¡¨ç°Tabï¼š** è¯¥æ¨¡æ¿å…³è”çš„æ‰€æœ‰agentå®ä¾‹çš„performanceæ•°æ®æ±‡æ€»
**å‡çº§è®°å½•Tabï¼š** è¯¥æ¨¡æ¿çš„æ‰€æœ‰UpgradeProposalå†å²ï¼Œå«æ•ˆæœå¯¹æ¯”ï¼ˆå‡çº§å‰åçš„é€šè¿‡ç‡å˜åŒ–ï¼‰

### 4.5 å·¥ä½œæµè¿è¡Œè¯¦æƒ…é¡µå¢å¼º

`WorkflowRunDetail.tsx` æ–°å¢ï¼š
- **åœæ­¢æŒ‰é’®** â€” è¿è¡Œä¸­çš„workflowæ˜¾ç¤ºçº¢è‰²"åœæ­¢"æŒ‰é’®ï¼Œç‚¹å‡»è°ƒç”¨ `/api/workflow-runs/:id/stop`
- ç¡®è®¤å¼¹çª—ï¼š"ç¡®å®šåœæ­¢è¯¥å·¥ä½œæµï¼Ÿè¿™å°†ä¸­æ–­æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„Agentä»»åŠ¡"

---

## Part 5ï¼šå‡çº§åº”ç”¨æµç¨‹

å®¡æ‰¹é€šè¿‡åè‡ªåŠ¨æ‰§è¡Œï¼š

```go
func (s *TemplateService) ApplyUpgrade(proposal *entity.UpgradeProposal) error {
    // 1. è§£æ ProposedChanges JSON
    // 2. æ›´æ–° AgentTemplateFile è¡¨ä¸­å¯¹åº”æ–‡ä»¶å†…å®¹
    // 3. åˆ›å»ºæ–°ç‰ˆæœ¬ AgentTemplateVersionï¼ˆè‡ªåŠ¨bumpç‰ˆæœ¬å·ï¼‰
    // 4. æ‰¾åˆ°æ‰€æœ‰ç»‘å®šè¯¥æ¨¡æ¿çš„ AgentInstance
    // 5. å¯¹æ¯ä¸ªå®ä¾‹æ‰§è¡Œ syncï¼ˆå†™å…¥workspaceç›®å½•çš„å®é™…æ–‡ä»¶ï¼‰
    // 6. æ›´æ–° proposal.Status = "applied"
    // 7. è®°å½•æ—¥å¿—
}
```

**Syncåˆ°workspaceçš„æœºåˆ¶ï¼ˆå·²æœ‰ï¼Œç¡®è®¤å¯ç”¨ï¼‰ï¼š**
- è¯»å– AgentInstance.WorkspacePathï¼ˆå¦‚ `/home/claw/.openclaw/workspace-ux/`ï¼‰
- å°†æ¨¡æ¿æ–‡ä»¶å†™å…¥å¯¹åº”è·¯å¾„ï¼ˆAGENTS.md, TOOLS.mdç­‰ï¼‰
- Agentä¸‹æ¬¡turnè‡ªåŠ¨è¯»å–æ–°é…ç½®

---

## Part 6ï¼šæ•ˆæœè¿½è¸ª

å‡çº§åº”ç”¨åï¼Œç³»ç»Ÿè‡ªåŠ¨å¯¹æ¯”å‡çº§å‰åçš„performanceæ•°æ®ï¼š

```go
type UpgradeEffect struct {
    ProposalID        string  `json:"proposal_id"`
    MetricName        string  `json:"metric_name"`         // gate_pass_rate, first_pass_rate, avg_time
    BeforeValue       float64 `json:"before_value"`        // å‡çº§å‰ï¼ˆæœ€è¿‘Næ¬¡ï¼‰
    AfterValue        float64 `json:"after_value"`         // å‡çº§åï¼ˆæœ€è¿‘Næ¬¡ï¼‰
    ImprovementPct    float64 `json:"improvement_pct"`     // æå‡ç™¾åˆ†æ¯”
    SampleSize        int     `json:"sample_size"`         // æ ·æœ¬æ•°
}
```

åœ¨å‡çº§ææ¡ˆè¯¦æƒ…é¡µå’Œæ¨¡æ¿è¯¦æƒ…é¡µå±•ç¤ºæ•ˆæœå¯¹æ¯”ã€‚

---

## ä»»åŠ¡æ‹†è§£ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰

### ä»»åŠ¡1ï¼šå·¥ä½œæµåœæ­¢èƒ½åŠ›
- `workflow_engine.go` â€” `StopRun()` æ–¹æ³•
- `gateway/client.go` â€” `SendStop()` æ–¹æ³•ï¼ˆé€šè¿‡agent RPCå‘/stopï¼‰
- `handler.go` â€” `POST /api/workflow-runs/:id/stop` ç«¯ç‚¹
- `WorkflowRunDetail.tsx` â€” åœæ­¢æŒ‰é’® + ç¡®è®¤å¼¹çª—

### ä»»åŠ¡2ï¼šPerformanceæ•°æ®æ¨¡å‹ + é‡‡é›†
- `entity.go` â€” æ–°å¢ AgentPerformance, UpgradeProposal å®ä½“
- `repository/performance_repository.go` â€” æ–°å¢
- `workflow_engine.go` â€” åœ¨stepå®Œæˆæ—¶è°ƒç”¨ `recordPerformance()`
- é‡‡é›†gateå¾ªç¯ã€escalateã€å®¡æ‰¹ç»“æœã€æ‰§è¡Œæ—¶é—´ç­‰

### ä»»åŠ¡3ï¼šè¿è¡Œè¡¨ç°é¡µé¢
- `acp-web/src/pages/AgentPerformance.tsx` â€” æ–°é¡µé¢
- `acp-web/src/api/performance.ts` â€” APIå±‚
- `handler/performance_handler.go` â€” åç«¯APIï¼ˆèšåˆæŸ¥è¯¢ï¼‰
- åŒ…å«ï¼šAgentå¡ç‰‡ç»Ÿè®¡ã€è¶‹åŠ¿å›¾ï¼ˆå¯ç”¨ç®€å•çš„CSSæŸ±çŠ¶å›¾ï¼Œä¸éœ€è¦å¼•å…¥å›¾è¡¨åº“ï¼‰ã€é—®é¢˜Top5ã€è¿è¡Œè®°å½•è¡¨

### ä»»åŠ¡4ï¼šè‡ªåŠ¨å‡çº§è§¦å‘ + ææ¡ˆç”Ÿæˆ
- `service/upgrade_service.go` â€” æ–°å¢
  - `PostRunAnalysis()` â€” runç»“æŸåè‡ªåŠ¨åˆ†æ
  - `CheckTriggers()` â€” æ£€æŸ¥å‡çº§æ¡ä»¶
  - `GenerateProposal()` â€” ç”Ÿæˆå‡çº§ææ¡ˆ
- `workflow_engine.go` â€” runç»“æŸæ—¶è°ƒç”¨ `PostRunAnalysis()`
- å‡çº§ææ¡ˆå…³è”å®¡æ‰¹ï¼ˆå¤ç”¨ç°æœ‰å®¡æ‰¹ç³»ç»Ÿï¼‰

### ä»»åŠ¡5ï¼šå‡çº§ææ¡ˆé¡µé¢
- `acp-web/src/pages/UpgradeProposals.tsx` â€” åˆ—è¡¨é¡µ
- `acp-web/src/pages/UpgradeProposalDetail.tsx` â€” è¯¦æƒ…é¡µï¼ˆå«diffé¢„è§ˆã€å…³è”æ•°æ®ã€å®¡æ‰¹æŒ‰é’®ï¼‰
- `acp-web/src/api/upgrades.ts` â€” APIå±‚
- `handler/upgrade_handler.go` â€” åç«¯API

### ä»»åŠ¡6ï¼šå‡çº§åº”ç”¨ + æ•ˆæœè¿½è¸ª
- `service/upgrade_service.go` â€” `ApplyUpgrade()` æ–¹æ³•
- å®¡æ‰¹é€šè¿‡åè‡ªåŠ¨åº”ç”¨åˆ°æ¨¡æ¿ + syncåˆ°workspace
- æ•ˆæœè¿½è¸ªï¼šå¯¹æ¯”å‡çº§å‰åperformanceæ•°æ®
- åœ¨ææ¡ˆè¯¦æƒ…é¡µå±•ç¤ºæ•ˆæœå¯¹æ¯”

### ä»»åŠ¡7ï¼šä¾§è¾¹æ  + è·¯ç”± + å¯¼èˆªè°ƒæ•´
- `MainLayout.tsx` â€” è°ƒæ•´ä¾§è¾¹æ ï¼Œæ–°å¢"Agentè¿›åŒ–"åˆ†ç»„
- `App.tsx` â€” æ–°å¢è·¯ç”±
- `AgentTemplateDetail.tsx` â€” å¢åŠ "è¿è¡Œè¡¨ç°"å’Œ"å‡çº§è®°å½•"Tab

### ä»»åŠ¡8ï¼šæ›´æ–°æ–‡æ¡£
- æ›´æ–° `docs/workflow-reference.md` â€” æ–°å¢å·¥ä½œæµåœæ­¢è¯´æ˜
- æ–°å¢ `docs/agent-evolution.md` â€” Agentè¿›åŒ–ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ç¼–è¯‘éƒ¨ç½²

```bash
cd /home/claw/.openclaw/workspace/agent-control-panel
go build -o bin/acp ./cmd/acp/
cd acp-web && npm run build && cp -r dist/* ../web/
kill $(pgrep -f 'bin/acp') 2>/dev/null; sleep 1; nohup ./bin/acp > acp.log 2>&1 &
```

## éªŒè¯è¦æ±‚

1. åœæ­¢å·¥ä½œæµï¼šå¯åŠ¨ä¸€ä¸ªå·¥ä½œæµ â†’ è¿è¡Œä¸­ç‚¹åœæ­¢ â†’ éªŒè¯agentæ”¶åˆ°/stopã€æ‰€æœ‰stepæ ‡è®°cancelled
2. Performanceé‡‡é›†ï¼šè¿è¡Œä¸€ä¸ªå®Œæ•´å·¥ä½œæµ â†’ æ£€æŸ¥agent_performancesè¡¨æœ‰æ•°æ®
3. è¿è¡Œè¡¨ç°é¡µé¢ï¼šèƒ½çœ‹åˆ°agentç»Ÿè®¡å¡ç‰‡å’Œè¿è¡Œè®°å½•
4. å‡çº§è§¦å‘ï¼šæ¨¡æ‹Ÿgateå¤±è´¥ç‡è¶…æ ‡ â†’ éªŒè¯è‡ªåŠ¨ç”ŸæˆUpgradeProposal
5. å‡çº§åº”ç”¨ï¼šå®¡æ‰¹é€šè¿‡ææ¡ˆ â†’ éªŒè¯æ¨¡æ¿æ–‡ä»¶æ›´æ–° â†’ workspaceåŒæ­¥
6. æ¯ä¸ªä»»åŠ¡å®Œæˆå commit + push
